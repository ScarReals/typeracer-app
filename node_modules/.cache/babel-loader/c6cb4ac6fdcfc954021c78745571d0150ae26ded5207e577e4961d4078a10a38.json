{"ast":null,"code":"// src/escrow.js\n\nimport * as anchor from \"@coral-xyz/anchor\";\nimport { PublicKey, SystemProgram, Transaction } from \"@solana/web3.js\";\nimport idl from \"./idl/typeracer_escrow.json\";\nconst PROGRAM_ID = new PublicKey(idl.metadata.address);\nfunction getProvider() {\n  const prov = anchor.getProvider();\n  if (!prov) throw new Error(\"Provider not set. Call setProvider in App.jsx first.\");\n  return prov;\n}\nfunction getProgram() {\n  return new anchor.Program(idl, PROGRAM_ID, getProvider());\n}\nasync function fetchEscrowVault(escrowPda) {\n  var _ref, _acct$escrowAccount;\n  const program = getProgram();\n  const acct = await program.account.escrow.fetch(escrowPda);\n  console.log(\"⛓️ escrow account data:\", acct);\n  const vault = (_ref = (_acct$escrowAccount = acct.escrowAccount) !== null && _acct$escrowAccount !== void 0 ? _acct$escrowAccount : acct.escrowVault) !== null && _ref !== void 0 ? _ref : acct.vault;\n  if (vault) return vault;\n  console.warn(\"No vault field found; using PDA itself\");\n  return escrowPda;\n}\nasync function sendTx(instructions) {\n  const provider = getProvider();\n  const connection = provider.connection;\n  const wallet = provider.wallet;\n  const tx = new Transaction().add(...instructions);\n  tx.feePayer = wallet.publicKey;\n  const {\n    blockhash,\n    lastValidBlockHeight\n  } = await connection.getLatestBlockhash(\"confirmed\");\n  tx.recentBlockhash = blockhash;\n\n  // Let wallet sign\n  const signed = await wallet.signTransaction(tx);\n\n  // Send raw\n  const sig = await connection.sendRawTransaction(signed.serialize(), {\n    skipPreflight: false,\n    preflightCommitment: \"confirmed\"\n  });\n\n  // Confirm\n  await connection.confirmTransaction({\n    signature: sig,\n    blockhash,\n    lastValidBlockHeight\n  }, \"confirmed\");\n  return sig;\n}\nexport async function initializeEscrow(wagerLamports) {\n  const provider = getProvider();\n  const program = getProgram();\n  const nonce = Math.floor(Math.random() * 1000000);\n  const [escrowPda] = await PublicKey.findProgramAddress([Buffer.from(\"escrow\"), provider.wallet.publicKey.toBuffer(), new anchor.BN(nonce).toArrayLike(Buffer, \"le\", 8)], program.programId);\n  const ixInit = await program.methods.initialize(new anchor.BN(wagerLamports), new anchor.BN(nonce)).accounts({\n    escrow: escrowPda,\n    player1: provider.wallet.publicKey,\n    authority: provider.wallet.publicKey,\n    systemProgram: SystemProgram.programId\n  }).instruction();\n  const ixDeposit = await program.methods.deposit().accounts({\n    escrow: escrowPda,\n    payer: provider.wallet.publicKey,\n    escrowAccount: escrowPda,\n    systemProgram: SystemProgram.programId\n  }).instruction();\n  await sendTx([ixInit, ixDeposit]);\n  return escrowPda;\n}\nexport async function joinAndDeposit(escrowPda) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n  const ix = await program.methods.joinAndDeposit().accounts({\n    escrow: escrowPda,\n    player2: provider.wallet.publicKey,\n    escrowAccount: vault,\n    systemProgram: SystemProgram.programId\n  }).instruction();\n  await sendTx([ix]);\n}\nexport async function cancelEscrow(escrowPda, player1Pubkey, player2Pubkey) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n  const ix = await program.methods.cancel().accounts({\n    escrow: escrowPda,\n    player1: player1Pubkey,\n    player2: player2Pubkey,\n    escrowAccount: vault,\n    authority: provider.wallet.publicKey\n  }).instruction();\n  await sendTx([ix]);\n}\nexport async function resolveEscrow(escrowPda, winnerPubkey) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n  const ix = await program.methods.resolve(winnerPubkey).accounts({\n    escrow: escrowPda,\n    winner: winnerPubkey,\n    house: provider.wallet.publicKey,\n    escrowAccount: vault,\n    authority: provider.wallet.publicKey\n  }).instruction();\n  await sendTx([ix]);\n}","map":{"version":3,"names":["anchor","PublicKey","SystemProgram","Transaction","idl","PROGRAM_ID","metadata","address","getProvider","prov","Error","getProgram","Program","fetchEscrowVault","escrowPda","_ref","_acct$escrowAccount","program","acct","account","escrow","fetch","console","log","vault","escrowAccount","escrowVault","warn","sendTx","instructions","provider","connection","wallet","tx","add","feePayer","publicKey","blockhash","lastValidBlockHeight","getLatestBlockhash","recentBlockhash","signed","signTransaction","sig","sendRawTransaction","serialize","skipPreflight","preflightCommitment","confirmTransaction","signature","initializeEscrow","wagerLamports","nonce","Math","floor","random","findProgramAddress","Buffer","from","toBuffer","BN","toArrayLike","programId","ixInit","methods","initialize","accounts","player1","authority","systemProgram","instruction","ixDeposit","deposit","payer","joinAndDeposit","ix","player2","cancelEscrow","player1Pubkey","player2Pubkey","cancel","resolveEscrow","winnerPubkey","resolve","winner","house"],"sources":["/home/kokoi/sol-wager-app/frontend/src/escrow.js"],"sourcesContent":["// src/escrow.js\n\nimport * as anchor from \"@coral-xyz/anchor\";\nimport { PublicKey, SystemProgram, Transaction } from \"@solana/web3.js\";\nimport idl from \"./idl/typeracer_escrow.json\";\n\nconst PROGRAM_ID = new PublicKey(idl.metadata.address);\n\nfunction getProvider() {\n  const prov = anchor.getProvider();\n  if (!prov) throw new Error(\"Provider not set. Call setProvider in App.jsx first.\");\n  return prov;\n}\n\nfunction getProgram() {\n  return new anchor.Program(idl, PROGRAM_ID, getProvider());\n}\n\nasync function fetchEscrowVault(escrowPda) {\n  const program = getProgram();\n  const acct = await program.account.escrow.fetch(escrowPda);\n  console.log(\"⛓️ escrow account data:\", acct);\n  const vault = acct.escrowAccount ?? acct.escrowVault ?? acct.vault;\n  if (vault) return vault;\n  console.warn(\"No vault field found; using PDA itself\");\n  return escrowPda;\n}\n\nasync function sendTx(instructions) {\n  const provider = getProvider();\n  const connection = provider.connection;\n  const wallet = provider.wallet;\n\n  const tx = new Transaction().add(...instructions);\n  tx.feePayer = wallet.publicKey;\n\n  const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash(\"confirmed\");\n  tx.recentBlockhash = blockhash;\n\n  // Let wallet sign\n  const signed = await wallet.signTransaction(tx);\n\n  // Send raw\n  const sig = await connection.sendRawTransaction(signed.serialize(), {\n    skipPreflight: false,\n    preflightCommitment: \"confirmed\",\n  });\n\n  // Confirm\n  await connection.confirmTransaction(\n    { signature: sig, blockhash, lastValidBlockHeight },\n    \"confirmed\"\n  );\n\n  return sig;\n}\n\nexport async function initializeEscrow(wagerLamports) {\n  const provider = getProvider();\n  const program = getProgram();\n\n  const nonce = Math.floor(Math.random() * 1_000_000);\n  const [escrowPda] = await PublicKey.findProgramAddress(\n    [\n      Buffer.from(\"escrow\"),\n      provider.wallet.publicKey.toBuffer(),\n      new anchor.BN(nonce).toArrayLike(Buffer, \"le\", 8),\n    ],\n    program.programId\n  );\n\n  const ixInit = await program.methods\n    .initialize(new anchor.BN(wagerLamports), new anchor.BN(nonce))\n    .accounts({\n      escrow: escrowPda,\n      player1: provider.wallet.publicKey,\n      authority: provider.wallet.publicKey,\n      systemProgram: SystemProgram.programId,\n    })\n    .instruction();\n\n  const ixDeposit = await program.methods\n    .deposit()\n    .accounts({\n      escrow: escrowPda,\n      payer: provider.wallet.publicKey,\n      escrowAccount: escrowPda,\n      systemProgram: SystemProgram.programId,\n    })\n    .instruction();\n\n  await sendTx([ixInit, ixDeposit]);\n  return escrowPda;\n}\n\nexport async function joinAndDeposit(escrowPda) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n\n  const ix = await program.methods\n    .joinAndDeposit()\n    .accounts({\n      escrow: escrowPda,\n      player2: provider.wallet.publicKey,\n      escrowAccount: vault,\n      systemProgram: SystemProgram.programId,\n    })\n    .instruction();\n\n  await sendTx([ix]);\n}\n\nexport async function cancelEscrow(escrowPda, player1Pubkey, player2Pubkey) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n\n  const ix = await program.methods\n    .cancel()\n    .accounts({\n      escrow: escrowPda,\n      player1: player1Pubkey,\n      player2: player2Pubkey,\n      escrowAccount: vault,\n      authority: provider.wallet.publicKey,\n    })\n    .instruction();\n\n  await sendTx([ix]);\n}\n\nexport async function resolveEscrow(escrowPda, winnerPubkey) {\n  const program = getProgram();\n  const provider = getProvider();\n  const vault = await fetchEscrowVault(escrowPda);\n\n  const ix = await program.methods\n    .resolve(winnerPubkey)\n    .accounts({\n      escrow: escrowPda,\n      winner: winnerPubkey,\n      house: provider.wallet.publicKey,\n      escrowAccount: vault,\n      authority: provider.wallet.publicKey,\n    })\n    .instruction();\n\n  await sendTx([ix]);\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}